<ion-header [translucent]="false">
  <ion-toolbar>
    <ion-title>Ajustes</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="settings-content">
  <div class="settings-container">
    <div class="settings-wrapper">
      <ion-list lines="none" class="settings-list settings-list--auth">
        @let authUser = (authUser$ | async);
        @if (!authUser) {
          <ion-item
            button
            detail="false"
            class="settings-item settings-item--auth"
            (click)="handleGoogleSignIn()"
          >
            <ion-icon
              aria-hidden="true"
              class="settings-item__icon"
              name="logo-google"
              slot="start"
            ></ion-icon>
            <ion-label>
              <h2>Inicia sesión con Google</h2>
              <p>
                Al iniciar sesión habilitas funciones opcionales de sincronización. Puedes seguir usando la app sin hacerlo.
              </p>
            </ion-label>
            @if (isSigningIn() || isSigningOut()) {
              <ion-spinner slot="end"></ion-spinner>
            }
          </ion-item>
        }

        @if (authUser) {
          <ion-item lines="none" class="settings-auth-item">
            <ion-avatar slot="start" class="settings-auth-item__avatar">
              @if (authUser.photoUrl) {
                <img
                  [alt]="authUser.displayName ?? 'Foto de perfil'"
                  [src]="authUser.photoUrl"
                />
              } @else {
                <div aria-hidden="true" class="settings-auth-item__avatar-fallback">
                  {{ (authUser.displayName ?? authUser.email ?? 'G').charAt(0).toUpperCase() }}
                </div>
              }
            </ion-avatar>
            <ion-label>
              <h3>{{ authUser.displayName ?? 'Cuenta de Google' }}</h3>
              @if (authUser.email) {
                <p>{{ authUser.email }}</p>
              }
            </ion-label>
            @if (isSigningIn() || isSigningOut()) {
              <ion-spinner slot="end"></ion-spinner>
            } @else {
              <ion-button
                color="danger"
                slot="end"
                (click)="handleGoogleSignOut()"
              >
                Cerrar sesión
              </ion-button>
            }
          </ion-item>

          @if (shouldShowAuthDebugInfo) {
            <ion-text color="medium" class="settings-auth-debug">
              <pre>{{ authUser | json }}</pre>
            </ion-text>

            <ion-item
              button
              detail="false"
              class="settings-item settings-item--auth"
              (click)="handleShowUploadedFiles()"
            >
              <ion-icon
                aria-hidden="true"
                class="settings-item__icon"
                name="bug-outline"
                slot="start"
              ></ion-icon>
              <ion-label>
                <h2>Mostrar archivos subidos</h2>
                <p>
                  Muestra en consola los archivos que se han subido durante la sincronización.
                </p>
              </ion-label>
              @if (isSyncing) {
                <ion-spinner slot="end"></ion-spinner>
              }
            </ion-item>

            <ion-item
              button
              detail="false"
              class="settings-item settings-item--auth"
              (click)="handleShowLastUploadedFileContent()"
            >
              <ion-icon
                aria-hidden="true"
                class="settings-item__icon"
                name="bug-outline"
                slot="start"
              ></ion-icon>
              <ion-label>
                <h2>Mostrar contenido del archivo</h2>
                <p>
                  Muestra en consola el contenido del último archivo subido.
                </p>
              </ion-label>
              @if (isSyncing) {
                <ion-spinner slot="end"></ion-spinner>
              }
            </ion-item>

            <ion-item
              button
              detail="false"
              class="settings-item settings-item--auth"
              (click)="handleClearRemoteData()"
            >
              <ion-icon
                aria-hidden="true"
                class="settings-item__icon"
                name="bug-outline"
                slot="start"
              ></ion-icon>
              <ion-label>
                <h2>Eliminar archivos subidos</h2>
                <p>
                  Elimina los archivos que se han subido durante la sincronización.
                </p>
              </ion-label>
              @if (isSyncing) {
                <ion-spinner slot="end"></ion-spinner>
              }
            </ion-item>

            <ion-item
              button
              detail="false"
              class="settings-item settings-item--auth"
              (click)="handleUploadFile()"
            >
              <ion-icon
                aria-hidden="true"
                class="settings-item__icon"
                name="sync-outline"
                slot="start"
              ></ion-icon>
              <ion-label>
                <h2>Subir datos</h2>
                <p>
                  Sube tus transacciones en la nube.
                </p>
              </ion-label>
              @if (isSyncing) {
                <ion-spinner slot="end"></ion-spinner>
              }
            </ion-item>
          }

          <ion-item
            button
            detail="false"
            class="settings-item settings-item--auth"
            (click)="handleSync()"
          >
            <ion-icon
              aria-hidden="true"
              class="settings-item__icon"
              name="sync-outline"
              slot="start"
            ></ion-icon>
            <ion-label>
              <h2>Sincronizar datos</h2>
              <p>
                Guarda y actualiza tus transacciones en la nube.
              </p>
            </ion-label>
            @if (isSyncing) {
              <ion-spinner slot="end"></ion-spinner>
            }
          </ion-item>
        }
      </ion-list>

      <ion-list lines="none" class="settings-list">
        <ion-item
          button
          detail="false"
          class="settings-item"
          (click)="handleImport()"
        >
          <ion-icon
            aria-hidden="true"
            class="settings-item__icon"
            name="cloud-upload-outline"
            slot="start"
          ></ion-icon>
          <ion-label>
            <h2>Importar transacciones</h2>
            <p>
              Carga un archivo JSON exportado previamente para restaurar tus registros.
            </p>
          </ion-label>
        </ion-item>

        <ion-item
          button
          detail="false"
          class="settings-item"
          (click)="handleExport()"
        >
          <ion-icon
            aria-hidden="true"
            class="settings-item__icon"
            name="cloud-download-outline"
            slot="start"
          ></ion-icon>
          <ion-label>
            <h2>Exportar transacciones</h2>
            <p>
              Descarga un archivo JSON con todas las transacciones almacenadas actualmente.
            </p>
          </ion-label>
        </ion-item>
        @if (shouldShowAuthDebugInfo) {
          <ion-item
            button
            detail="false"
            class="settings-item"
            (click)="handleDeleteAllData()"
          >
            <ion-icon
              aria-hidden="true"
              class="settings-item__icon"
              name="close-circle-outline"
              slot="start"
              style="color: red"
            ></ion-icon>
            <ion-label>
              <h2>Eliminar transacciones</h2>
              <p>
                Elimina todas las transacciones almacenadas actualmente.
              </p>
            </ion-label>
          </ion-item>
        }
      </ion-list>

      <ion-text color="medium" class="settings-hint">
        <ion-icon
          aria-hidden="true"
          class="settings-hint__icon"
          name="warning-outline"
        ></ion-icon>
        <p>
          Los archivos generados e importados deben mantenerse seguros; contienen todos tus datos.
        </p>
      </ion-text>
    </div>

    <ion-text color="medium" class="settings-version">
      <p>Versión {{ appVersion }}</p>
    </ion-text>
  </div>

  <input
    #fileInput
    accept="application/json"
    class="settings-file-input"
    type="file"
    (change)="handleFileSelected($event)"
  />
</ion-content>
